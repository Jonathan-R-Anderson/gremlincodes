<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysAdmin - Gremlin DAO</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <h1>SysAdmin Page</h1>
    <button onclick="tipMyself()">Tip Myself Tokens</button>

    <script>
        let gremlinDAOContract;

        async function fetchContractData() {
            try {
                const response = await fetch('/contract_data');
                const data = await response.json();

                if (typeof window.ethereum !== 'undefined') {
                    const web3 = new Web3(window.ethereum);
                    gremlinDAOContract = new web3.eth.Contract(data.gremlinDAOABI, data.gremlinDAOAddress);

                    // Request account access if needed
                    await window.ethereum.request({ method: 'eth_requestAccounts' });

                    console.log('Contract initialized:', gremlinDAOContract);
                } else {
                    alert('MetaMask is not installed. Please install MetaMask to use this application.');
                }
            } catch (error) {
                console.error('Error fetching contract data:', error);
                alert('An error occurred while fetching contract data. Please try again later.');
            }
        }

        async function connectMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    return accounts[0];
                } catch (error) {
                    console.error('Error connecting to MetaMask:', error);
                    alert('An error occurred while connecting to MetaMask. Please try again.');
                }
            } else {
                alert('MetaMask is not installed. Please install MetaMask to use this application.');
            }
        }

        async function tipUser(recipient, timeOnPage, avgTimeOnPage) {
            try {
                const fromAddress = await connectMetaMask();

                console.log('Tipping user:', recipient, 'with timeOnPage:', timeOnPage, 'avgTimeOnPage:', avgTimeOnPage);

                await gremlinDAOContract.methods.tipToken(recipient, timeOnPage, avgTimeOnPage)
                    .send({ from: fromAddress, gas: 200000 });

                alert('Tipped successfully!');
            } catch (error) {
                console.error('Error tipping user:', error);
                alert(`An error occurred while tipping. Error: ${error.message}`);
            }
        }

        async function tipMyself() {
            const recipient = await connectMetaMask(); // Get the current user's address
            const timeOnPage = 120; // Example: User has been on the page for 120 seconds
            const avgTimeOnPage = 1; // Example: Average time on page is 60 seconds

            tipUser(recipient, timeOnPage, avgTimeOnPage);
        }

        // Call fetchContractData to initialize the contracts when the page loads
        window.onload = fetchContractData;
    </script>
</body>
</html>
