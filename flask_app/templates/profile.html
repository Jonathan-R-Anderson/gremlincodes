{% extends "base.html" %}

{% block content %}
<h1>User Profile</h1>
<h2>Ethereum Address: <span id="eth-address">{{ eth_address }}</span></h2>

<!-- Display the Magnet URL -->
<h3>Magnet URL: <a href="{{ magnet_url }}">{{ magnet_url }}</a></h3>

<video id="streamPlayer" controls autoplay></video>

<p id="countdown-message">Starting your stream in 60 seconds...</p>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/webtorrent/webtorrent.min.js"></script>

<script>
    const ethAddress = "{{ eth_address }}";
    const magnetUrl = "{{ magnet_url }}";
    const client = new WebTorrent();
    const countdownMessage = document.getElementById("countdown-message");

    let countdownTime = 60;  // 60 seconds countdown
    let countdownInterval = setInterval(function () {
        countdownMessage.innerText = `Starting your stream in ${countdownTime} seconds...`;
        countdownTime--;

        if (countdownTime <= 0) {
            clearInterval(countdownInterval);  // Stop the countdown
            countdownMessage.innerText = "Stream starting now...";

            // Start streaming the video after the delay
            if (magnetUrl) {
                client.add(magnetUrl, function (torrent) {
                    torrent.files.forEach(function (file) {
                        if (file.name.endsWith('.mp4') || file.name.endsWith('.m3u8') || file.name.endsWith('.ts')) {
                            file.renderTo('video#streamPlayer', {
                                autoplay: true,
                                controls: true
                            });
                        } else {
                            console.error('Unsupported file type:', file.name);
                        }
                    });
                });
            } else {
                console.error("Magnet URL not available.");
            }
        }
    }, 1000);  // Countdown in 1-second intervals
</script>
{% endblock %}
