{% extends "base.html" %}

{% block content %}
<h1>User Profile</h1>

<!-- Display Ethereum Address -->
<h2>Ethereum Address: <span id="eth-address">{{ eth_address }}</span></h2>

<!-- Video Player -->
<video id="streamPlayer" controls autoplay></video>

<!-- Magnet URL Information -->
<h3>Latest Magnet URL: <span id="magnet-url">Loading...</span></h3>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/webtorrent/webtorrent.min.js"></script>
<script>
    const ethAddress = "{{ eth_address }}";
    const client = new WebTorrent();
    let latestMagnetUrl = null;

    // Function to fetch the latest magnet URL for the stream
    function fetchMagnetUrl() {
        fetch(`/magnet_url/${ethAddress}`)
            .then(response => response.json())
            .then(data => {
                if (data.magnet_url && data.magnet_url !== latestMagnetUrl) {
                    latestMagnetUrl = data.magnet_url;
                    document.getElementById("magnet-url").textContent = latestMagnetUrl;

                    client.add(latestMagnetUrl, function (torrent) {
                        torrent.files[0].renderTo('video#streamPlayer');
                        console.log("Playing new stream with Magnet URL:", latestMagnetUrl);
                    });
                }
            })
            .catch(error => {
                console.error("Error fetching magnet URL:", error);
            });
    }

    // Poll for new magnet URLs every 5 seconds
    setInterval(fetchMagnetUrl, 5000);

    // Initialize the Ethereum address on page load
    window.onload = function () {
        document.getElementById('eth-address').textContent = ethAddress;
        fetchMagnetUrl();  // Fetch the initial magnet URL
    };
</script>
{% endblock %}
